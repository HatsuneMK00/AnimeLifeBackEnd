on:
  pull_request:
    branches:
      - deploy

jobs:
  build-and-deploy:
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout
      uses: actions/checkout@v3.3.0
      
    - name: Set up go env
      uses: actions/setup-go@v3.5.0
      with:
        go-version: 1.20
        
    - name: Set current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y%m%d%H%M')"
        
    - name: Build
      run: go build -tags=release -o ./go_build_linux_linux_$CURRENT_DATE ./main.go
      env:
        CURRENT_DATE: ${{ steps.date.outputs.date }}
      
    - name: Deploy to Aliyun
      uses: easingthemes/ssh-deploy@v4.1.8
      with:
        SSH_PRIVATE_KEY: ${{ secrets.REMOTE_PRIVATE_KEY }}
        ARGS: "-rlgoDzvc -i --delete"
        SOURCE: "./"
        TARGET: ${{ secrets.REMOTE_TARGET }}
        REMOTE_HOST:  ${{ secrets.REMOTE_HOST }}
        REMOTE_USER: ${{ secrets.REMOTE_USER }}
        
